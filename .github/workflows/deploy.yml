name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Application to EC2
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Debug secrets (optional, you can remove later)
      - name: Debug SSH secret
        run: |
          echo "HOME is: $HOME"
          echo "SSH key length: $(echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | wc -c)"
          echo "Host: ${{ secrets.EC2_HOST }}"

      # Step 3: Set up SSH key safely
      - name: Set up SSH key
        run: |
          echo "ðŸ Checking secrets..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ Error: EC2_HOST secret is missing. Please add it in your repository Settings â†’ Secrets and variables â†’ Actions."
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: EC2_SSH_PRIVATE_KEY secret is missing. Please add your EC2 private key there."
            exit 1
          fi

          echo "âœ… All secrets found. Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "ðŸ” Adding EC2 host to known_hosts..."
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          echo "âœ… SSH setup completed successfully."

      # Step 4: Deploy to EC2 via SSH
      - name: Deploy to EC2
        run: |
          echo "ðŸš€ Starting deployment on EC2..."
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/app || mkdir -p /home/ubuntu/app && cd /home/ubuntu/app
            echo "ðŸ“¦ Pulling latest changes..."
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin main
            fi
            echo "âš™ï¸ Restarting application..."
            # Example for Node.js (customize this part as per your app)
            npm install --production || true
            pm2 restart all || pm2 start app.js --name simple-app
            echo "âœ… Deployment complete!"
          EOF
